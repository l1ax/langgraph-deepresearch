# 1. åŸºç¡€é•œåƒï¼šä½¿ç”¨æ ‡å‡†ç‰ˆ node:20 (Debian)ï¼Œç¡®ä¿åº•å±‚åº“å…¼å®¹æ€§
FROM node:20 AS base

# å¯ç”¨ pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

# --- ä¾èµ–å®‰è£…é˜¶æ®µ (æœ€å®¹æ˜“æŠ¥é”™çš„é˜¶æ®µ) ---
FROM base AS deps
WORKDIR /app

# è§£å†³ sharp, node-gyp, bcrypt ç­‰åº“åœ¨å®‰è£…æ—¶æŠ¥ python/make/g++ not found çš„é”™è¯¯
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶
COPY package.json pnpm-lock.yaml* ./

# å¿…é¡»åœ¨ pnpm install ä¹‹å‰å¤åˆ¶ï¼Œå¦åˆ™ postinstall è„šæœ¬æ‰¾ä¸åˆ° schema ä¼šæŠ¥é”™
COPY prisma ./prisma

# å®‰è£…ä¾èµ–
# --unsafe-perm: é˜²æ­¢ root ç”¨æˆ·æƒé™é—®é¢˜
# --no-optional: è·³è¿‡ä¸å…¼å®¹çš„å¯é€‰ä¾èµ–
RUN pnpm install --unsafe-perm --no-optional

# --- æ„å»ºé˜¶æ®µ ---
FROM base AS builder
WORKDIR /app

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules
COPY . .

ARG NEXT_PUBLIC_LANGGRAPH_API_URL
ENV NEXT_PUBLIC_LANGGRAPH_API_URL=${NEXT_PUBLIC_LANGGRAPH_API_URL}

RUN npx prisma generate

# ğŸ”¥ æ„å»ºé¡¹ç›® (éœ€è¦æœåŠ¡å™¨å¼€å¯ Swapï¼Œæˆ–è€…åœ¨ GitHub Actions é‡Œè·‘)
RUN pnpm run build

# --- è¿è¡Œé˜¶æ®µ (æœ€ç»ˆäº§ç‰©) ---
# ä½¿ç”¨ slim é•œåƒå‡å°ä½“ç§¯ï¼Œä½†ä¿ç•™ Debian å…¼å®¹æ€§
FROM node:20-slim AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN groupadd --system --gid 1001 nodejs
RUN useradd --system --uid 1001 nextjs

# å¤åˆ¶ public æ–‡ä»¶å¤¹
COPY --from=builder /app/public ./public

# è‡ªåŠ¨åˆ›å»º .next æ–‡ä»¶å¤¹æƒé™
RUN mkdir .next
RUN chown nextjs:nodejs .next

COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# åˆ‡æ¢ç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
