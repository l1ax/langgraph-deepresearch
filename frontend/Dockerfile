# 1. åŸºç¡€é•œåƒï¼šä½¿ç”¨æ ‡å‡†ç‰ˆ node:20 (Debian)ï¼Œç¡®ä¿åº•å±‚åº“å…¼å®¹æ€§
FROM node:20 AS base

# å¯ç”¨ pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

# --- ä¾èµ–å®‰è£…é˜¶æ®µ (æœ€å®¹æ˜“æŠ¥é”™çš„é˜¶æ®µ) ---
FROM base AS deps
WORKDIR /app

# ğŸ”¥ å…³é”®ä¿®å¤ 1ï¼šæ‰‹åŠ¨å®‰è£…ç¼–è¯‘å·¥å…·
# è§£å†³ sharp, node-gyp, bcrypt ç­‰åº“åœ¨å®‰è£…æ—¶æŠ¥ python/make/g++ not found çš„é”™è¯¯
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶
COPY package.json pnpm-lock.yaml* ./

# ğŸ”¥ å…³é”®ä¿®å¤ 2ï¼šæå‰å¤åˆ¶ Prisma Schema
# å¿…é¡»åœ¨ pnpm install ä¹‹å‰å¤åˆ¶ï¼Œå¦åˆ™ postinstall è„šæœ¬æ‰¾ä¸åˆ° schema ä¼šæŠ¥é”™
COPY prisma ./prisma

# å®‰è£…ä¾èµ–
# --unsafe-perm: é˜²æ­¢ root ç”¨æˆ·æƒé™é—®é¢˜
# --no-optional: è·³è¿‡ä¸å…¼å®¹çš„å¯é€‰ä¾èµ–
RUN pnpm install --unsafe-perm

# --- æ„å»ºé˜¶æ®µ ---
FROM base AS builder
WORKDIR /app

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# æ¥æ”¶æ„å»ºå‚æ•° (å¦‚æœæœ‰ NEXT_PUBLIC_ å˜é‡éœ€è¦åœ¨è¿™é‡Œæ¥æ”¶)
ARG NEXT_PUBLIC_LANGGRAPH_API_URL
ENV NEXT_PUBLIC_LANGGRAPH_API_URL=${NEXT_PUBLIC_LANGGRAPH_API_URL}

# å†æ¬¡ç”Ÿæˆ Prisma Client (åŒé‡ä¿é™©)
RUN npx prisma generate
ENV NODE_OPTIONS="--max-old-space-size=4096"
# ğŸ”¥ æ„å»ºé¡¹ç›® (éœ€è¦æœåŠ¡å™¨å¼€å¯ Swapï¼Œæˆ–è€…åœ¨ GitHub Actions é‡Œè·‘)
RUN pnpm run build

# --- è¿è¡Œé˜¶æ®µ (æœ€ç»ˆäº§ç‰©) ---
# ä½¿ç”¨ slim é•œåƒå‡å°ä½“ç§¯ï¼Œä½†ä¿ç•™ Debian å…¼å®¹æ€§
FROM node:20-slim AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# åˆ›å»ºé root ç”¨æˆ· (å®‰å…¨æœ€ä½³å®è·µ)
RUN groupadd --system --gid 1001 nodejs
RUN useradd --system --uid 1001 nextjs

# å¤åˆ¶ public æ–‡ä»¶å¤¹
COPY --from=builder /app/public ./public

# è‡ªåŠ¨åˆ›å»º .next æ–‡ä»¶å¤¹æƒé™
RUN mkdir .next
RUN chown nextjs:nodejs .next

# ğŸ”¥ å…³é”®ä¿®å¤ 3ï¼šæ­£ç¡®å¤åˆ¶ Standalone äº§ç‰©
# Standalone æ¨¡å¼ä¸‹ï¼Œserver.js å’Œ node_modules éƒ½åœ¨ .next/standalone é‡Œ
# æˆ‘ä»¬æŠŠå®ƒç›´æ¥å¤åˆ¶åˆ°å®¹å™¨æ ¹ç›®å½• /app ä¸‹
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# åˆ‡æ¢ç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# å¯åŠ¨å‘½ä»¤ (è¿™å›è‚¯å®šèƒ½æ‰¾åˆ° server.js äº†)
CMD ["node", "server.js"]
